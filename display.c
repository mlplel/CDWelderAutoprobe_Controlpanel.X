/*
 * 
 * 
 * 
 * 
 * 
 * 
 */

#include "display.h"
#include "i2c.h"
#include "menu.h"
//#include "maincharset.h"

#include <stdlib.h>
#include <stdbool.h>

enum DISPLAYITEM_SIZE { DISPLAYITEM_SIZE = 68 };
const uint8_t maincharset[];
 const uint8_t colpos[] = {
     0x04, 0x0E, 0x18, 0x22, 0x2C, 0x36, 0x40, 0x4A, 0x54, 0x5E, 0x68, 0x72
 };
 
 const uint8_t linepos[] = {
     0x00, 0x02, 0x04, 0x06, 0x00     
 }; 
 
 /*
  * 
  */
 static DISPLAYITEM di[DISPLAYITEM_SIZE];
 
 
 /*
  * 
  */
 void dispmem_init(){
     int i;
     for(i = 0;i<DISPLAYITEM_SIZE;i++){
         di[i].active = 0;
         di[i].priority = 0;
     }  
 }
 /*
  * 
  */
 uint8_t* dispmem_alloc(){
     int i;
     for(i=0;i<DISPLAYITEM_SIZE;i++){
         if(di[i].active == 0){
             // slot is open use it
             di[i].active = 1;
             return &(di[i].data[0]);
         }
     }   
     return NULL;
 }
 
 /*
  * 
  */
 void dispmem_free(uint8_t* p){
     int i;
     for(i=0;i<DISPLAYITEM_SIZE;i++){
         if(p == &(di[i].data[0])){
             //location found free it.
             di[i].active = 0;
             return;
         }
     }
     
     
     
 }
 
 /*
  * 
  * file only functions
  */
 void sh1106_clearline(uint8_t line);

 CURSORPOS cursorpos = {0, 0, false};
 bool cursorblink = true;
/*
 * 
 */
void sh1106_on(void) {
    uint8_t *pdata;
    //if ((pdata = (uint8_t *) malloc(2)) == NULL) {
    if((pdata = dispmem_alloc()) == NULL){
        // fatal error need to reset
        // need error handler here
        while (1);
    }
    *(pdata + 0) = 0x00;
    *(pdata + 1) = 0xAF; // turn display on
    i2c_Write(pdata, 2);
}

/*
 * 
 */
void sh1106_setup(void){
    while(i2c_Ready() != I2C_STATUS_IDLE);
    uint8_t *pdata;
    //if((pdata = (uint8_t *)malloc(6)) == NULL){
     if((pdata = dispmem_alloc()) == NULL){   
        // fatal error need to reset
        // need error handler here
        while(1);
    }
    *pdata = 0x80;
    *(pdata + 1) = 0xA1;  //segment remap left
    *(pdata + 2) = 0x80;
    *(pdata + 3) = 0xC8;  //set scan direction
    *(pdata + 4) = 0x00;
    *(pdata + 5) = 0x40;  //set scan display line
    // init sh1106
    i2c_Write(pdata, 6);   
 }
 
 /*
  *     blocking call only call from init routines.
  */
 void sh1106_clear(void){
    uint8_t *pdata;
    uint8_t page = 0;    
    while (page < 8) {
        //if ((pdata = (uint8_t *) malloc(140)) == NULL) {
        if((pdata = dispmem_alloc()) == NULL){
            // fatal error need to reset
            // need error handler here
            while (1);
        }
        *(pdata + 0) = 0x80;
        *(pdata + 1) = 0xB0 + page; // select page 0
        *(pdata + 2) = 0x80;
        *(pdata + 3) = 0x00;
        *(pdata + 4) = 0x80;
        *(pdata + 5) = 0x10; // column 0
        *(pdata + 6) = 0x40;
        int i = 7;
        //139 
        for (; i < 139;) {
            *(pdata + i) = 0x00;
            i++;
        }        
        while(i2c_Ready() != I2C_STATUS_IDLE);
        i2c_Write(pdata, i);
        page++;        
    }  
 }
 
/*
 * 
 */
bool sh1106_clearpage(uint8_t page) {
    uint8_t *pdata;
    //if ((pdata = (uint8_t *) malloc(140)) == NULL) {
    if((pdata = dispmem_alloc()) == NULL){
        // fatal error need to reset
        // need error handler here
        while (1);
    }
    *(pdata + 0) = 0x80;
    *(pdata + 1) = 0xB0 + page;
    *(pdata + 2) = 0x80;
    *(pdata + 3) = 0x00;
    *(pdata + 4) = 0x80;
    *(pdata + 5) = 0x10; // column 0
    *(pdata + 6) = 0x40;
    int i = 7;
    //139 
    for (; i < 139;) {
        *(pdata + i) = 0x00;
        i++;
    }
    if (i2c_Write(pdata, i) == I2C_STATUS_FULL) {
        //free(pdata);
        dispmem_free(pdata);
        return false;
    }
    return true;
}

 
 /*
  * 
  */
 void sh1106_clearline(uint8_t line) {
    uint8_t *pdata;
    //if ((pdata = (uint8_t *) malloc(140)) == NULL) {
    if((pdata = dispmem_alloc()) == NULL){
        // fatal error need to reset
        // need error handler here
        while (1);
    }
    uint8_t page = linepos[line];
    *(pdata + 0) = 0x80;
    *(pdata + 1) = 0xB0 + page;
    *(pdata + 2) = 0x80;
    *(pdata + 3) = 0x00;
    *(pdata + 4) = 0x80;
    *(pdata + 5) = 0x10; // column 0
    *(pdata + 6) = 0x40;
    int i = 7;
    //139 
    for (; i < 139;) {
        *(pdata + i) = 0x00;
        i++;
    }
    if (i2c_Write(pdata, i) == I2C_STATUS_FULL) {
        free(pdata);
    }
      //if ((pdata = (uint8_t *) malloc(140)) == NULL) {
    if((pdata = dispmem_alloc()) == NULL){
        // fatal error need to reset
        // need error handler here
        while (1);
    }
    *(pdata + 0) = 0x80;
    *(pdata + 1) = 0xB0 + page + 1;
    *(pdata + 2) = 0x80;
    *(pdata + 3) = 0x00;
    *(pdata + 4) = 0x80;
    *(pdata + 5) = 0x10; // column 0
    *(pdata + 6) = 0x40;
    i = 7;
    //139 
    for (; i < 139;) {
        *(pdata + i) = 0x00;
        i++;
    }
    if (i2c_Write(pdata, i) == I2C_STATUS_FULL) {
        //free(pdata);
        dispmem_free(pdata);
    }
 }
 
 /*
  *  display large char at position on display   
  */
 bool sh1106_charat(uint8_t col, uint8_t line, int chr){
       uint8_t *pdata;
    //if ((pdata = (uint8_t *) malloc(140)) == NULL) {
    if((pdata = dispmem_alloc()) == NULL){   
        // fatal error need to reset
        // need error handler here
        while (1);
    } 
    
    int charindx = chr * 20;
    uint8_t page = linepos[line];
    uint8_t collow = colpos[col] & 0x0F;
    int8_t colhigh = (colpos[col] >> 4) | 0x10;
    int i = 0;

    *(pdata + i) = 0x80;
    i++;
    *(pdata + i) = 0xB0 + page; //select page 0 - 7
    i++;
    *(pdata + i) = 0x80;
    i++;
    *(pdata + i) = collow;
    i++;
    *(pdata + i) = 0x80;
    i++;
    *(pdata + i) = colhigh;
    i++;
    int j;
    for (j = 0; j < 10; j++) {
        *(pdata + i) = 0xC0;
        i++;
        *(pdata + i) = maincharset[charindx];
        i++;
        charindx++;
    }

    *(pdata + i) = 0x80;
    i++;
    *(pdata + i) = 0xB0 + page + 1; //select page 0 - 7
    i++;
    *(pdata + i) = 0x80;
    i++;
    *(pdata + i) = collow;
    i++;
    *(pdata + i) = 0x80;
    i++;
    *(pdata + i) = colhigh;
    i++;
    for (j = 0; j < 9; j++) {
        *(pdata + i) = 0xC0;
        i++;
        *(pdata + i) = maincharset[charindx];
        i++;
        charindx++;
    }
    *(pdata + i) = 0x40;
    i++;
    *(pdata + i) = maincharset[charindx];
    i++;
    charindx++;    

    if (i2c_Write(pdata, i) == I2C_STATUS_FULL) {
        //free(pdata);
        dispmem_free(pdata);
        return false;
    }
    return true;
 }
 /*
  * 
  */
 void display_int(int16_t val, uint8_t line) {
    bool negf;
    uint8_t pos = 6;

    if (val < 0) {
        negf = true;
        val = (~val + 1);
    } else {
        negf = false;
    }

    if (val == 0) {
        sh1106_charat(1, line, 0);
        sh1106_charat(2, line, 0);
        sh1106_charat(3, line, 0);
        sh1106_charat(4, line, 0);
        sh1106_charat(5, line, 0);
        sh1106_charat(6, line, 10);
        return;
    }

    int dig;

    while (val != 0) {

        dig = val % 10;
        if (dig == 0)
            dig = 10;
        sh1106_charat(pos, line, dig);

        val = val / 10;
        pos--;
    }

    if (negf == true) {
        sh1106_charat(pos, line, 11);
        pos--;
    }

    for (; pos > 0; pos--) {
        sh1106_charat(pos, line, 0);
    }
}
 
 /*
  * 
  */
 bool display_2digit(uint8_t val, uint8_t col, uint8_t line) {
   
    uint8_t pos = col + 1;

    if ((val == 0) || (val > 99)) {
        if(!sh1106_charat(col, line, 0)) return false;
        if(!sh1106_charat(col+1, line, 10)) return false;
        return true;
    }

    int dig;

    while (val != 0) {
        dig = val % 10;
        if (dig == 0)
            dig = 10;
        if(!sh1106_charat(pos, line, dig)) return false;
        val = val / 10;
        pos--;
    }

    for (; pos >= col; pos--) {
        if(!sh1106_charat(pos, line, 0)) return false;
    }
    return true;
 }
 
 
 /*
  * 
  */
 bool display_5digit(uint16_t val, uint8_t col, uint8_t line) {   
    if(col > 7) return true;     
    uint8_t pos = col + 4;

    if (val == 0) {
        if(!sh1106_charat(col, line, 0)) return false;
        if(!sh1106_charat(col+1, line, 0)) return false;
        if(!sh1106_charat(col+2, line, 0)) return false;
        if(!sh1106_charat(col+3, line, 0)) return false;
        if(!sh1106_charat(col+4, line, 10)) return false;
        return true;
    }

    int dig;

    while (val != 0) {
        dig = val % 10;
        if (dig == 0)
            dig = 10;
        if(!sh1106_charat(pos, line, dig)) return false;
        val = val / 10;
        pos--;
    }

    for (; pos >= col; pos--) {
        if(!sh1106_charat(pos, line, 0)) return false;
    }
    return true;
 }
 
 
 
/*
 * 
 */
 void cursor(CURSORPOS cp){
    if ((cp.cursorcol == cursorpos.cursorcol) && (cp.cursorline == cursorpos.cursorline)) {
        cursorpos.visible = cp.visible;
        if(cp.visible){
            sh1106_charat(cursorpos.cursorcol, cursorpos.cursorline, 39);
        } else{
            sh1106_charat(cursorpos.cursorcol, cursorpos.cursorline, 0);
        }
    } else {
        sh1106_charat(cursorpos.cursorcol, cursorpos.cursorline, 0);
        cursorpos = cp;
        if(cp.visible){
            sh1106_charat(cursorpos.cursorcol, cursorpos.cursorline, 39);
        }
        cursorblink = true;
    }
 }
 
 /*
  * 
  */
 void cursorflash(){
     if(!cursorpos.visible){
         return;
     }
     sh1106_charat(cursorpos.cursorcol, cursorpos.cursorline, cursorblink ? 0 : 39);
     cursorblink = !cursorblink;
 }
 
/*
 * 
 */
bool display_menu(MENUDATA m) {
    static uint16_t state = 0;
    while (state < 8) {
        // clear the display.
        if (!sh1106_clearpage(state)) {
            return false;
        }
        state++;
    }
    while (state < 8 + m.count) {
        int pos = state - 8;
        if (!sh1106_charat(m.data[pos].col, m.data[pos].row, m.data[pos].ch)) {
            return false;
        }
        state++;
    }
    state = 0;
    return true;
}

 
 const uint8_t maincharset[] = {
     // 0 = ' '
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    // 1 = '1'
    0x00, 0x04, 0x06, 0x02, 0x02, 0xfe, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x40, 0x40, 0x40, 0x40, 0x7f, 0x40, 0x40, 0x40, 0x00,
    // 2 = '2'
    0x00, 0x10, 0x08, 0x04, 0x02, 0x02, 0x04, 0x88, 0x70, 0x00,
    0x00, 0x60, 0x50, 0x48, 0x44, 0x42, 0x41, 0x40, 0x40, 0x00,
    // 3 = '3'
    0x00, 0x10, 0x08, 0x04, 0x82, 0x82, 0x84, 0x48, 0x30, 0x00,
    0x00, 0x08, 0x10, 0x20, 0x41, 0x41, 0x21, 0x12, 0x0c, 0x00,
    // 4 = '4'
    0x00, 0xfe, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0xfe, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x7f, 0x00,
    // 5 = '5'
    0x00, 0xfe, 0x82, 0x82, 0x82, 0x82, 0x02, 0x02, 0x02, 0x00,
    0x00, 0x40, 0x40, 0x40, 0x40, 0x40, 0x21, 0x12, 0x0c, 0x00,
    // 6 = '6'
    0x00, 0x80, 0x60, 0x10, 0x88, 0x84, 0x02, 0x02, 0x00, 0x00,
    0x00, 0x0f, 0x12, 0x21, 0x40, 0x40, 0x21, 0x12, 0x0c, 0x00,
    // 7 = '7'
    0x00, 0x02, 0x02, 0x02, 0x02, 0x82, 0x62, 0x1a, 0x06, 0x00,
    0x00, 0x00, 0x60, 0x18, 0x06, 0x01, 0x00, 0x00, 0x00, 0x00,
    // '8'
    0x00, 0x30, 0x48, 0x84, 0x82, 0x82, 0x84, 0x48, 0x30, 0x00,
    0x00, 0x0c, 0x12, 0x21, 0x41, 0x41, 0x21, 0x12, 0x0c, 0x00,
    // '9'
    0x00, 0x30, 0x48, 0x84, 0x02, 0x02, 0x84, 0x48, 0xf0, 0x00,
    0x00, 0x00, 0x40, 0x20, 0x11, 0x09, 0x04, 0x02, 0x01, 0x00,
    // 10 = '0'
    0x00, 0xf0, 0x08, 0x04, 0x02, 0x02, 0x04, 0x08, 0xf0, 0x00,
    0x00, 0x0f, 0x10, 0x20, 0x40, 0x40, 0x20, 0x10, 0x0f, 0x00,
    // 11 = '-'
    0x00, 0xc0, 0xc0, 0xc0, 0xc0, 0xc0, 0xc0, 0xc0, 0xc0, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    // ' '
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    // 'A'
    0x00, 0x00, 0xf0, 0x0c, 0x02, 0x02, 0x0c, 0xf0, 0x00, 0x00,
    0x00, 0x3e, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x3e, 0x00,
    // 'B'
    0x00, 0xfe, 0x82, 0x82, 0x82, 0x82, 0x82, 0x44, 0x38, 0x00,
    0x00, 0x7f, 0x41, 0x41, 0x41, 0x41, 0x41, 0x22, 0x1c, 0x00,
    // 15 = 'C'
    0x00, 0xfc, 0x06, 0x02, 0x02, 0x02, 0x02, 0x02, 0x04, 0x00,
    0x00, 0x3f, 0x60, 0x40, 0x40, 0x40, 0x40, 0x40, 0x20, 0x00,
    // 'D'
    0x00, 0xfe, 0x02, 0x02, 0x02, 0x02, 0x04, 0x18, 0xe0, 0x00,
    0x00, 0x7f, 0x40, 0x40, 0x40, 0x40, 0x20, 0x18, 0x07, 0x00,
    // 'E'
    0x00, 0xfe, 0x82, 0x82, 0x82, 0x82, 0x82, 0x02, 0x02, 0x00,
    0x00, 0x7f, 0x41, 0x41, 0x41, 0x41, 0x41, 0x40, 0x40, 0x00,
    // 'F'
    0x00, 0xfe, 0x82, 0x82, 0x82, 0x82, 0x82, 0x82, 0x02, 0x00,
    0x00, 0x7f, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    // 'G'
    0x00, 0xfc, 0x06, 0x02, 0x02, 0x02, 0x02, 0x02, 0x0c, 0x00,
    0x00, 0x3f, 0x60, 0x40, 0x40, 0x42, 0x41, 0x61, 0x3f, 0x00,
    // 20 = 'H'
    0x00, 0xfe, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0xfe, 0x00,
    0x00, 0x7f, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x7f, 0x00,
    // 'I'
    0x00, 0x02, 0x02, 0x02, 0xfe, 0xfe, 0x02, 0x02, 0x02, 0x00,
    0x00, 0x40, 0x40, 0x40, 0x7f, 0x7f, 0x40, 0x40, 0x40, 0x00,
    // 'J'
    0x00, 0x02, 0x02, 0x02, 0x02, 0xfe, 0x02, 0x02, 0x02, 0x00,
    0x00, 0x18, 0x20, 0x40, 0x40, 0x3f, 0x00, 0x00, 0x00, 0x00,
    // 'K'
    0x00, 0xfe, 0x80, 0xc0, 0x60, 0x30, 0x18, 0x0c, 0x06, 0x00,
    0x00, 0x7f, 0x03, 0x03, 0x06, 0x0c, 0x18, 0x30, 0x60, 0x00,
    // 'L'
    0x00, 0xfe, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x7f, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x00,
    // 25 = 'M'
    0x00, 0xfe, 0x0e, 0x70, 0x80, 0x80, 0x70, 0x0e, 0xfe, 0x00,
    0x00, 0x7f, 0x00, 0x00, 0x03, 0x03, 0x00, 0x00, 0x7f, 0x00,
    // 'N'
    0x00, 0xfe, 0x0e, 0x30, 0xc0, 0x00, 0x00, 0x00, 0xfe, 0x00,
    0x00, 0x7f, 0x00, 0x00, 0x00, 0x03, 0x0c, 0x70, 0x7f, 0x00,
    // 'O'
    0x00, 0xfc, 0x06, 0x02, 0x02, 0x02, 0x02, 0x06, 0xfc, 0x00,
    0x00, 0x3f, 0x60, 0x40, 0x40, 0x40, 0x40, 0x60, 0x3f, 0x00,
    // 'P'
    0x00, 0xfe, 0x02, 0x02, 0x02, 0x02, 0x02, 0x84, 0x78, 0x00,
    0x00, 0x7f, 0x01, 0x01, 0x01, 0x01, 0x01, 0x00, 0x00, 0x00,
    // 'Q'
    0x00, 0xfc, 0x06, 0x02, 0x02, 0x02, 0x02, 0x06, 0xfc, 0x00,
    0x00, 0x1f, 0x30, 0x20, 0x20, 0x24, 0x28, 0x10, 0x2f, 0x00,
    // 30 = 'R'
    0x00, 0xfe, 0x02, 0x02, 0x02, 0x02, 0x02, 0x84, 0x78, 0x00,
    0x00, 0x7f, 0x01, 0x03, 0x05, 0x09, 0x11, 0x20, 0x40, 0x00,
    // 'S'
    0x00, 0x7c, 0xc6, 0x82, 0x82, 0x82, 0x82, 0x02, 0x04, 0x00,
    0x00, 0x20, 0x40, 0x40, 0x40, 0x40, 0x40, 0x61, 0x3f, 0x00,
    // 'T'
    0x00, 0x02, 0x02, 0x02, 0x02, 0xfe, 0x02, 0x02, 0x02, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x7f, 0x00, 0x00, 0x00, 0x00,
    // 'U'
    0x00, 0xfe, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xfe, 0x00,
    0x00, 0x3f, 0x60, 0x40, 0x40, 0x40, 0x40, 0x60, 0x3f, 0x00,
    // 'V'
    0x00, 0x0e, 0xf0, 0x00, 0x00, 0x00, 0x00, 0xf0, 0x0e, 0x00,
    0x00, 0x00, 0x00, 0x0f, 0x70, 0x70, 0x0f, 0x00, 0x00, 0x00,
    // 35 = 'W'
    0x00, 0xfe, 0x00, 0x00, 0xf0, 0xf0, 0x00, 0x00, 0xfe, 0x00,
    0x00, 0x7f, 0x70, 0x0f, 0x00, 0x00, 0x0f, 0x70, 0x7f, 0x00,
    // 'X'
    0x00, 0x06, 0x18, 0x60, 0x80, 0x80, 0x60, 0x18, 0x06, 0x00,
    0x00, 0x60, 0x18, 0x06, 0x01, 0x01, 0x06, 0x18, 0x60, 0x00,
    // 'Y'
    0x00, 0x06, 0x18, 0x20, 0x40, 0x80, 0x60, 0x18, 0x06, 0x00,
    0x00, 0x60, 0x18, 0x06, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00,
    // 'Z'
    0x00, 0x02, 0x02, 0x02, 0x02, 0x82, 0x62, 0x1a, 0x06, 0x00,
    0x00, 0x60, 0x58, 0x46, 0x41, 0x40, 0x40, 0x40, 0x40, 0x00,
    // 39 = '>'
    0x00, 0x00, 0xFC, 0xF8, 0xF0, 0xE0, 0xC0, 0x80, 0x00, 0x00,
    0x00, 0x00, 0x7F, 0x3F, 0x1F, 0x0F, 0x07, 0x03, 0x01, 0x00
};

